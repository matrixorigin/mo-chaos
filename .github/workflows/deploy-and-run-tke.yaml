name: Deploy Mo Cluster and Run Chaos Experiment on TKE
on:
  workflow_dispatch:
jobs:
  Deploy:
    runs-on: amd64-tke-dind
    steps:
      - uses: actions/checkout@v2
      - name: Deploy
        run: |
          chmod +x .github/workflows/tke/install-mo.sh
          .github/workflows/tke/install-mo.sh
        shell: bash
      - name: Upload mo cluster artifact
        uses: actions/upload-artifact@v3
        with:
          name: mo-cluster
          path: |
            mo-cluster.yaml
            uuid
# todo bvt_test
#  Run-Chaos:
#    runs-on: amd64-tke-dind
#    needs:
#      - deploy
#    container:
#      image: matrixorigin/mo-chaos-driller:1.0.0-beta9
#    steps:
#      - run: python main.py
#        name: Run
  Cleanup:
    runs-on: amd64-tke-dind
    if: always()
    needs:
      - Deploy
#      - Run-Chaos
    steps:
      - uses: actions/checkout@v2
      - name: Download mo cluster artifact
        uses: actions/download-artifact@v3
        with:
          name: mo-cluster
          path: .
      - name: Cleanup
        run: |
          chmod +x .github/workflows/tke/clean-mo.sh
          .github/workflows/tke/clean-mo.sh
        shell: bash